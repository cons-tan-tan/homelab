- name: Check if Tailscale is installed
  ansible.builtin.command: tailscale version
  register: tailscale_check
  changed_when: false
  failed_when: false

- name: Install Tailscale
  when: tailscale_check.rc != 0
  block:
    - name: Download Tailscale install script
      ansible.builtin.get_url:
        url: https://tailscale.com/install.sh
        dest: /tmp/tailscale-install.sh
        mode: "0755"

    - name: Run Tailscale install script
      ansible.builtin.command: /tmp/tailscale-install.sh
      changed_when: true

    - name: Remove install script
      ansible.builtin.file:
        path: /tmp/tailscale-install.sh
        state: absent

- name: Enable and start tailscaled
  ansible.builtin.systemd:
    name: tailscaled
    enabled: true
    state: started

- name: Check Tailscale status
  ansible.builtin.command: tailscale status
  register: tailscale_status
  changed_when: false
  failed_when: false

- name: Determine if Tailscale needs authentication
  ansible.builtin.set_fact:
    tailscale_needs_auth: "{{ 'Logged out.' in tailscale_status.stdout or tailscale_status.rc != 0 }}"

- name: Fail if auth needed but no key provided
  when: tailscale_needs_auth and (tailscale_auth_key | length == 0)
  ansible.builtin.fail:
    msg: >-
      Tailscale is not authenticated. Provide auth key via:
      ansible-playbook site.yaml -e tailscale_auth_key=tskey-auth-xxxxx

- name: Connect to Tailscale
  when: tailscale_needs_auth
  ansible.builtin.command: tailscale up --authkey={{ tailscale_auth_key }}
  changed_when: true
  no_log: true
