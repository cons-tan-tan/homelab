# Gateway role: VPS をゲームサーバーへのリバースプロキシとして構成する
# ルールの詳細は templates/ を参照

- name: Enable IP forwarding
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: "1"
    sysctl_set: true
    state: present
    reload: true

- name: Ensure nftables config directory exists
  ansible.builtin.file:
    path: /etc/nftables.d
    state: directory
    mode: "0755"

- name: Deploy gateway nftables rules
  ansible.builtin.template:
    src: gateway.nft.j2
    dest: /etc/nftables.d/gateway.nft
    mode: "0644"
  notify: Apply gateway nftables rules

- name: Deploy gateway nftables systemd service
  ansible.builtin.template:
    src: gateway-nftables.service.j2
    dest: /etc/systemd/system/gateway-nftables.service
    mode: "0644"
  notify: Enable gateway nftables service
